# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **red team automation project** that integrates Sliver C2 framework with n8n workflow automation to provide real-time notifications when new implant connections are established. The system monitors both beacon and session callbacks and sends alerts to Discord and Slack.

**Authorization Context:** This is a defensive security/red team operations tool for authorized penetration testing and security research.

## Architecture

### Component Overview

1. **Python Monitor Service** (`sliver_beacon_monitor.py`)
   - Async monitoring daemon that connects to Sliver C2 server
   - Polls for new beacons and sessions every 5 seconds
   - Maintains persistent state in `beacon_state.json` to prevent duplicate alerts
   - Sends webhooks to n8n when new connections detected

2. **n8n Workflow** (JSON configuration included)
   - Webhook endpoint receives connection data from Python monitor
   - Formats data for Discord (color-coded embeds) and Slack (text messages)
   - Parallel notification delivery to both platforms
   - Returns success response to webhook caller

3. **Systemd Service** (`sliver-monitor.service`)
   - Runs monitor as background daemon
   - Auto-restarts on failure with 5-second delay
   - Depends on `sliver.service` to ensure C2 server is running first

### Data Flow

```
Sliver C2 Server
    ↓ (protobuf client)
Python Monitor (async polling)
    ↓ (HTTP POST webhook)
n8n Webhook Endpoint
    ↓ (parallel execution)
Discord + Slack Notifications
```

### Connection Type Differentiation

The monitor explicitly tags connections as "Session" (interactive) or "Beacon" (asynchronous):
- Sessions are tagged and color-coded red in Discord (color: 15158332)
- Beacons are tagged and color-coded green in Discord (color: 3066993)
- Both types are tracked separately then merged with explicit type labels

## Setup Commands

### Install Node.js and n8n

```bash
# Install NVM
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
source ~/.zshrc

# Install Node.js 24
nvm install 24

# Install n8n globally
npm install n8n -g
```

### Python Environment

The monitor requires:
- Python 3 with async support
- `sliver-py` library for C2 API access
- `requests` library for webhook calls
- Sliver client config file at `~/.sliver-client/configs/kali_localhost.cfg`

### Systemd Service Installation

1. Update paths in service file to match your Python environment (use `which python` to find correct path)
2. Place service file at `/etc/systemd/system/sliver-monitor.service`
3. Enable and start:

```bash
sudo systemctl daemon-reload
sudo systemctl enable sliver-monitor.service
sudo systemctl start sliver-monitor.service
sudo systemctl status sliver-monitor.service
```

## Configuration Requirements

### Critical Configuration Points

1. **n8n Webhook URL** (in Python script line 62):
   - Default: `http://localhost:5678/webhook/sliver-beacon`
   - Must match the webhook path in n8n workflow

2. **Sliver Config Path** (line 63):
   - Default: `~/.sliver-client/configs/kali_localhost.cfg`
   - Generated by Sliver client on first connection

3. **Discord Webhook** (in n8n workflow):
   - Requires Discord webhook URL configured in n8n credentials
   - Credential ID: `s2EfxTlE6XNXzEIA` (must be reconfigured for your instance)

4. **Slack Integration** (in n8n workflow):
   - Uses Bot User OAuth Token (starts with `xoxb-`)
   - Required scopes: `chat:write`, `chat:write.public`
   - Sends to channel named `c2-server`

## n8n Workflow Structure

The workflow has 5 nodes in sequence/parallel:

1. **Webhook - Sliver Beacon**: Receives POST requests with connection data
2. **Format Data**: Transforms incoming JSON into Discord color codes and Slack-formatted text
3. **Discord Notification** (parallel): Sends rich embed with color-coded alert
4. **Send a message** (parallel): Posts to Slack channel
5. **Webhook Response**: Returns success JSON to caller

### Import Workflow

The n8n workflow JSON is included in the documentation file. Import via:
- n8n UI → Settings → Import from File/URL → Paste JSON
- Update all credential IDs after import

## Key Implementation Details

### State Persistence

The monitor uses `beacon_state.json` to track known connection IDs:
- Prevents alert spam on service restart
- File location: Same directory as Python script
- Contains JSON array of connection ID strings

### Connection Detection Logic

From `sliver_beacon_monitor.py:124-166`:
- Fetches sessions and beacons separately using Sliver client API
- Tags each with explicit type before merging lists
- Only new IDs trigger webhooks
- State saved immediately after detection

### Webhook Payload Format

```json
{
  "event": "new_connection",
  "type": "Session" | "Beacon",
  "timestamp": "ISO8601Z",
  "id": "connection_id",
  "name": "implant_name",
  "hostname": "target_hostname",
  "username": "target_user",
  "os": "target_os",
  "arch": "architecture",
  "remote_address": "ip:port",
  "internal_ip": "extracted_ip",
  "transport": "connection_protocol"
}
```

## Troubleshooting

### Monitor Not Connecting to Sliver

- Verify Sliver server is running: `sudo systemctl status sliver.service`
- Check config path exists: `ls -la ~/.sliver-client/configs/`
- Test manual connection with Sliver client

### Webhooks Not Received in n8n

- Verify n8n is running on port 5678
- Check webhook is activated in n8n UI (workflow must be active)
- Test webhook manually: `curl -X POST http://localhost:5678/webhook/sliver-beacon -H "Content-Type: application/json" -d '{"test":"data"}'`

### Discord/Slack Not Receiving Alerts

- Check n8n execution log for errors
- Verify credentials are valid (may need to re-authenticate)
- For Slack: Ensure bot is invited to target channel
- For Discord: Test webhook URL directly in browser

## Security Considerations

- The monitor requires read access to Sliver client config (contains mTLS certificates)
- Webhook endpoint should be firewalled (localhost only recommended)
- State file contains connection IDs but no sensitive data
- Service runs as user `kali` (configurable in systemd unit)
